// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator erd {
  provider = "prisma-erd-generator"
  output = "./ERD.svg"
}

generator dbml {
  provider = "prisma-dbml-generator"
  output = "./schema.dbml"
}

// ============================================
// PLATFORM ZONE - Global/Shared Data
// ============================================

// Business Owners
model Owner {
  id           String    @id @default(cuid())
  email        String    @unique
  password     String
  name         String
  phone        String?
  isActive     Boolean   @default(true) @map("is_active")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  pharmacies   Pharmacy[]

  @@map("owners")
}

// Physical Pharmacy Stores
model Pharmacy {
  id            String   @id @default(cuid())
  ownerId       String   @map("owner_id")
  owner         Owner    @relation(fields: [ownerId], references: [id])
  name          String
  address       String
  latitude      Float
  longitude     Float
  phone         String
  email         String?
  hours         Json     // Operating hours: { "monday": "08:00-20:00", ... }
  serviceRadius Float    @default(10.0) @map("service_radius_km") // km
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  staff         PharmacyStaff[]
  inventory     PharmacyInventory[]
  orders        PharmacyOrder[]
  invoices     PharmacyInvoice[]
  purchaseInvoices PurchaseInvoice[]
  analytics     PharmacyAnalytics[]
  storageLocations StorageLocation[]
  deliveries    Delivery[]
  staffNotifications StaffNotification[]

  @@index([latitude, longitude]) // For geospatial queries
  @@index([ownerId])
  @@map("pharmacies")
}

// Customers (Shared across all pharmacies)
model Customer {
  id                String   @id @default(cuid())
  phone             String   @unique // Primary identifier
  email             String?
  password          String?  // Nullable for in-store registration
  fullName          String?  @map("full_name")
  verified          Boolean  @default(false)
  verifiedAt        DateTime? @map("verified_at")
  registrationSource String? @map("registration_source") // "mobile_app" | "in_store"
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  cart              CustomerCart?
  orders            PharmacyOrder[]
  invoices          PharmacyInvoice[]
  healthMetrics     CustomerHealthMetrics?
  healthRecords     CustomerHealthRecord[]
  allergies         CustomerAllergy[]
  reminders         MedicineReminder[]
  notifications     CustomerNotification[]
  pushTokens        CustomerPushToken[]
  reminderLogs      ReminderLog[]

  @@map("customers")
}

// Global Medicine Catalog (From Pharma Sales Reps)
model GlobalMedicineCatalog {
  id              String   @id @default(cuid())
  name            String
  manufacturer    String?
  description     String?
  packaging       String?  // "Box of 10 blisters"
  activeIngredient String? @map("active_ingredient")
  barcode         String?
  unitPrice       Decimal? @db.Decimal(10, 2) @map("unit_price")
  
  categoryId      String?  @map("category_id")
  category        Category? @relation(fields: [categoryId], references: [id])
  brandId         String?  @map("brand_id")
  brand           Brand?   @relation(fields: [brandId], references: [id])
  supplierId      String   @map("supplier_id")
  supplier        Supplier @relation(fields: [supplierId], references: [id])
  pharmaRepId     String   @map("pharma_rep_id")
  pharmaRep       PharmaSalesRep @relation(fields: [pharmaRepId], references: [id])
  
  inventoryItems  PharmacyInventory[]
  
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@index([name])
  @@index([manufacturer, brandId])
  @@index([supplierId])
  @@map("global_medicine_catalog")
}

// Pharma Sales Representatives
model PharmaSalesRep {
  id          String   @id @default(cuid())
  name        String
  email       String   @unique
  phone       String
  supplierId  String   @map("supplier_id")
  supplier    Supplier @relation(fields: [supplierId], references: [id])
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  catalogItems GlobalMedicineCatalog[]

  @@map("pharma_sales_reps")
}

// Suppliers
model Supplier {
  id          String   @id @default(cuid())
  name        String
  contactInfo Json     @map("contact_info") // { email, phone, address }
  address     String
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  salesReps   PharmaSalesRep[]
  catalogItems GlobalMedicineCatalog[]
  purchaseInvoices PurchaseInvoice[]

  @@map("suppliers")
}

// Shared Reference Data
model Category {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  catalogItems GlobalMedicineCatalog[]
  inventoryItems PharmacyInventory[]

  @@map("categories")
}

model Brand {
  id          String   @id @default(cuid())
  name        String   @unique
  manufacturer String?
  country     String?
  logo        String?
  imagePublicId String? @map("image_public_id")
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  catalogItems GlobalMedicineCatalog[]
  inventoryItems PharmacyInventory[]

  @@map("brands")
}

// News Articles
model News {
  id          String   @id @default(cuid())
  title       String
  category    String
  content     String   @db.Text
  image       String?
  imagePublicId String? @map("image_public_id")
  readingTime Int      @map("reading_time") // minutes
  summary     String?
  isFeatured  Boolean  @default(false) @map("is_featured")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("news")
}

// OTP Verification
model Otp {
  id          String   @id @default(cuid())
  phone       String
  otp         String
  expiresAt   DateTime @map("expires_at")
  isUsed      Boolean  @default(false) @map("is_used")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([phone, isUsed, expiresAt])
  @@map("otps")
}

// ============================================
// TENANT ZONE - Pharmacy-Specific Data
// ============================================

// Pharmacy Storage Locations (Shelf, Table, Room, etc.)
model StorageLocation {
  id          String   @id @default(cuid())
  pharmacyId  String   @map("pharmacy_id")
  pharmacy    Pharmacy @relation(fields: [pharmacyId], references: [id])
  name        String   // "Shelf 1", "Table 1", "Room 1", "Cold Storage", etc.
  description String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  inventoryItems PharmacyInventory[]

  @@index([pharmacyId])
  @@unique([pharmacyId, name]) // Each pharmacy can't have duplicate location names
  @@map("storage_locations")
}

// Pharmacy Staff/Employees
model PharmacyStaff {
  id          String   @id @default(cuid())
  pharmacyId  String   @map("pharmacy_id")
  pharmacy    Pharmacy @relation(fields: [pharmacyId], references: [id])
  username    String
  password    String   // Hashed
  name        String
  email       String   @unique
  role        StaffRole
  avatar      String?
  avatarPublicId String? @map("avatar_public_id")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  notifications StaffNotification[]
  deliveries    Delivery[] // Staff can be assigned as delivery person

  @@index([pharmacyId])
  @@index([email])
  @@map("pharmacy_staff")
}

enum StaffRole {
  MANAGER
  PHARMACIST
  STAFF
}

// Pharmacy Inventory (Stock per pharmacy)
model PharmacyInventory {
  id                  String   @id @default(cuid())
  pharmacyId          String   @map("pharmacy_id")
  pharmacy            Pharmacy @relation(fields: [pharmacyId], references: [id])
  
  globalCatalogId    String?   @map("global_catalog_id")
  globalCatalog      GlobalMedicineCatalog? @relation(fields: [globalCatalogId], references: [id])
  
  name                String   // Can override catalog name
  description         String?
  image               String?
  imagePublicId       String?   @map("image_public_id")
  
  categoryId          String?   @map("category_id")
  category            Category? @relation(fields: [categoryId], references: [id])
  brandId             String?   @map("brand_id")
  brand               Brand?    @relation(fields: [brandId], references: [id])
  storageLocationId   String?   @map("storage_location_id")
  storageLocation     StorageLocation? @relation(fields: [storageLocationId], references: [id])
  
  totalStockLevel     Int       @default(0) @map("total_stock_level")
  minStockLevel       Int       @default(10) @map("min_stock_level") // Default threshold
  
  units               InventoryUnit[]
  batches             InventoryBatch[]
  orderItems          OrderItem[]
  cartItems           CartItem[]
  invoiceItems        InvoiceItem[]
  purchaseItems       PurchaseItem[]
  
  isActive            Boolean   @default(true) @map("is_active")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  @@index([pharmacyId, name])
  @@index([pharmacyId, isActive])
  @@index([pharmacyId, categoryId])
  @@index([storageLocationId])
  @@map("pharmacy_inventory")
}

// Inventory Units (Selling units: Box, Blister, Pill)
model InventoryUnit {
  id                  String   @id @default(cuid())
  inventoryId         String   @map("inventory_id")
  inventory           PharmacyInventory @relation(fields: [inventoryId], references: [id], onDelete: Cascade)
  
  name                String   // "Hộp", "Vỉ", "Viên", "Chai"
  conversionFactor    Int      @map("conversion_factor")
  price               Decimal  @db.Decimal(10, 2)
  isBaseUnit          Boolean  @default(false) @map("is_base_unit")
  isDefaultSelling    Boolean  @default(false) @map("is_default_selling")
  
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  @@unique([inventoryId, name])
  @@map("inventory_units")
}

// Inventory Batches (For expiry tracking)
model InventoryBatch {
  id                  String   @id @default(cuid())
  inventoryId         String   @map("inventory_id")
  inventory           PharmacyInventory @relation(fields: [inventoryId], references: [id], onDelete: Cascade)
  
  batchCode           String   @map("batch_code")
  expiryDate          DateTime @map("expiry_date")
  stockQuantity       Int      @map("stock_quantity") // In BASE unit
  purchasePrice       Decimal? @db.Decimal(10, 2) @map("purchase_price")
  purchaseDate        DateTime? @map("purchase_date")
  
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  @@index([inventoryId, expiryDate]) // For FIFO queries
  @@index([expiryDate]) // For expiry alerts
  @@map("inventory_batches")
}

// Pharmacy Orders
model PharmacyOrder {
  id              String        @id @default(cuid())
  pharmacyId      String        @map("pharmacy_id")
  pharmacy        Pharmacy      @relation(fields: [pharmacyId], references: [id])
  customerId      String        @map("customer_id")
  customer        Customer      @relation(fields: [customerId], references: [id])
  
  orderNumber     String        @unique @map("order_number") // Auto-generated
  status          OrderStatus   @default(PENDING)
  subtotal        Decimal       @db.Decimal(10, 2)
  deliveryFee     Decimal       @default(0) @db.Decimal(10, 2) @map("delivery_fee")
  totalAmount     Decimal       @db.Decimal(10, 2) @map("total_amount")
  shippingAddress String        @map("shipping_address")
  note            String?
  
  paymentMethod   String?       @map("payment_method")
  paymentStatus   PaymentStatus @default(PENDING) @map("payment_status")
  
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  items           OrderItem[]
  delivery        Delivery?
  payment         Payment?
  invoice         PharmacyInvoice?

  @@index([pharmacyId, status])
  @@index([customerId])
  @@index([orderNumber])
  @@index([createdAt])
  @@map("pharmacy_orders")
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PREPARING
  OUT_FOR_DELIVERY
  DELIVERED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PAID
  REFUNDED
  FAILED
}

// Order Items
model OrderItem {
  id          String   @id @default(cuid())
  orderId     String   @map("order_id")
  order       PharmacyOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  inventoryId String   @map("inventory_id")
  inventory   PharmacyInventory @relation(fields: [inventoryId], references: [id])
  unitId      String?  @map("unit_id") // Which unit was sold (Box, Pill, etc.)
  quantity    Int
  price       Decimal  @db.Decimal(10, 2) // Price at time of order
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("order_items")
}

// Delivery Tracking
model Delivery {
  id                    String          @id @default(cuid())
  orderId               String          @unique @map("order_id")
  order                 PharmacyOrder   @relation(fields: [orderId], references: [id])
  pharmacyId            String          @map("pharmacy_id")
  pharmacy              Pharmacy        @relation(fields: [pharmacyId], references: [id])
  
  deliveryService       String          @map("delivery_service") // "internal", "grab", "now", "be"
  deliveryServiceOrderId String?        @map("delivery_service_order_id")
  deliveryStaffId       String?         @map("delivery_staff_id") // Staff member assigned for delivery
  deliveryStaff         PharmacyStaff? @relation(fields: [deliveryStaffId], references: [id])
  deliveryFee           Decimal         @db.Decimal(10, 2) @map("delivery_fee")
  estimatedDeliveryTime DateTime?       @map("estimated_delivery_time")
  actualDeliveryTime    DateTime?       @map("actual_delivery_time")
  status                DeliveryStatus  @default(PENDING)
  deliveryPersonName     String?        @map("delivery_person_name") // For external delivery services
  deliveryPersonPhone    String?        @map("delivery_person_phone") // For external delivery services
  trackingUrl            String?        @map("tracking_url")
  
  createdAt              DateTime        @default(now()) @map("created_at")
  updatedAt              DateTime        @updatedAt @map("updated_at")

  @@index([deliveryStaffId])
  @@map("deliveries")
}

enum DeliveryStatus {
  PENDING
  PICKED_UP
  IN_TRANSIT
  DELIVERED
  FAILED
}

// Payment Records
model Payment {
  id            String        @id @default(cuid())
  orderId       String        @unique @map("order_id")
  order         PharmacyOrder @relation(fields: [orderId], references: [id])
  amount        Decimal       @db.Decimal(10, 2)
  paymentMethod String        @map("payment_method")
  status        PaymentStatus @default(PENDING)
  transactionId String?       @map("transaction_id")
  paidAt        DateTime?     @map("paid_at")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  @@map("payments")
}

// Pharmacy Invoices
model PharmacyInvoice {
  id          String      @id @default(cuid())
  pharmacyId  String      @map("pharmacy_id")
  pharmacy    Pharmacy    @relation(fields: [pharmacyId], references: [id])
  customerId  String      @map("customer_id")
  customer    Customer    @relation(fields: [customerId], references: [id])
  orderId     String?     @unique @map("order_id") // Link to order if from online
  order       PharmacyOrder? @relation(fields: [orderId], references: [id])
  
  invoiceNumber String    @unique @map("invoice_number") // Auto-generated
  invoiceDate   DateTime  @default(now()) @map("invoice_date")
  totalAmount   Decimal   @db.Decimal(10, 2) @map("total_amount")
  type          InvoiceType @default(ONLINE)
  
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  items         InvoiceItem[]

  @@index([pharmacyId])
  @@index([customerId])
  @@index([invoiceNumber])
  @@map("pharmacy_invoices")
}

enum InvoiceType {
  ONLINE
  OFFLINE
}

// Purchase Invoices (Inbound Stock)
model PurchaseInvoice {
  id            String          @id @default(cuid())
  pharmacyId    String          @map("pharmacy_id")
  pharmacy      Pharmacy        @relation(fields: [pharmacyId], references: [id])
  supplierId    String?         @map("supplier_id")
  supplier      Supplier?       @relation(fields: [supplierId], references: [id])
  supplierName  String?         @map("supplier_name") // Fallback

  invoiceNumber String          @map("invoice_number") // Vendor's invoice #
  invoiceDate   DateTime        @default(now()) @map("invoice_date")
  totalAmount   Decimal         @db.Decimal(10, 2) @map("total_amount")
  
  status        PurchaseStatus  @default(PENDING)
  notes         String?
  
  items         PurchaseItem[]
  
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")

  @@index([pharmacyId])
  @@index([supplierId])
  @@map("purchase_invoices")
}

enum PurchaseStatus {
  PENDING
  CONFIRMED   // Stock added to inventory
  CANCELLED
}

// Purchase Items
model PurchaseItem {
  id                String          @id @default(cuid())
  purchaseInvoiceId String          @map("purchase_invoice_id")
  purchaseInvoice   PurchaseInvoice @relation(fields: [purchaseInvoiceId], references: [id], onDelete: Cascade)
  
  inventoryId       String          @map("inventory_id")
  inventory         PharmacyInventory @relation(fields: [inventoryId], references: [id])

  batchCode         String          @map("batch_code")
  expiryDate        DateTime        @map("expiry_date")
  
  quantity          Int             // In BASE unit
  unitPrice         Decimal         @db.Decimal(10, 2) @map("unit_price")
  totalPrice        Decimal         @db.Decimal(10, 2) @map("total_price")
  
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")

  @@map("purchase_items")
}

// Invoice Items
model InvoiceItem {
  id          String   @id @default(cuid())
  invoiceId   String   @map("invoice_id")
  invoice     PharmacyInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  inventoryId String?  @map("inventory_id")
  inventory   PharmacyInventory? @relation(fields: [inventoryId], references: [id])
  quantity    Int
  price       Decimal  @db.Decimal(10, 2)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("invoice_items")
}

// Pharmacy Analytics
model PharmacyAnalytics {
  id                String   @id @default(cuid())
  pharmacyId        String   @map("pharmacy_id")
  pharmacy          Pharmacy @relation(fields: [pharmacyId], references: [id])
  date              DateTime @db.Date
  totalRevenue      Decimal  @db.Decimal(10, 2) @map("total_revenue")
  totalOrders       Int      @map("total_orders")
  totalCustomers    Int      @map("total_customers")
  averageOrderValue Decimal  @db.Decimal(10, 2) @map("average_order_value")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@unique([pharmacyId, date])
  @@index([pharmacyId, date])
  @@map("pharmacy_analytics")
}

// Staff Notifications (In-web for pharmacy staff/owners)
// When an event occurs, create one notification per active staff member in the pharmacy
// This allows individual read tracking while broadcasting to all staff
model StaffNotification {
  id          String   @id @default(cuid())
  staffId     String   @map("staff_id") // Always set - one notification per staff member
  staff       PharmacyStaff @relation(fields: [staffId], references: [id])
  pharmacyId  String   @map("pharmacy_id")
  pharmacy    Pharmacy @relation(fields: [pharmacyId], references: [id])
  type        StaffNotificationType
  title       String
  message     String
  metadata    Json?    // Additional data (e.g., orderId, orderNumber, catalogId)
  isRead      Boolean  @default(false) @map("is_read")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([pharmacyId, isRead])
  @@index([staffId, isRead])
  @@index([pharmacyId, type, createdAt]) // For filtering by type
  @@index([createdAt])
  @@map("staff_notifications")
}

enum StaffNotificationType {
  ORDER_NEW              // New order received
  ORDER_DELETED          // Customer cancelled/deleted their order
  CATALOG_IMPORTED       // New catalog imported by sales rep
  INVENTORY_LOW_STOCK    // Inventory stock level below threshold
  INVENTORY_EXPIRY_ALERT // Medicine batch expiring soon
  PAYMENT_RECEIVED       // Payment received for an order
  SYSTEM_ALERT           // System-wide alerts (maintenance, updates, etc.)
}

// ============================================
// CROSS-ZONE - Customer-Related (Shared)
// ============================================

// Customer Shopping Cart
model CustomerCart {
  id          String   @id @default(cuid())
  customerId  String   @unique @map("customer_id")
  customer    Customer @relation(fields: [customerId], references: [id])
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  items       CartItem[]

  @@map("customer_carts")
}

// Cart Items
model CartItem {
  id          String   @id @default(cuid())
  cartId      String   @map("cart_id")
  cart        CustomerCart @relation(fields: [cartId], references: [id], onDelete: Cascade)
  inventoryId String   @map("inventory_id")
  inventory   PharmacyInventory @relation(fields: [inventoryId], references: [id])
  unitId      String?  @map("unit_id") // Selected unit
  quantity    Int
  unitPrice   Decimal  @db.Decimal(10, 2) @map("unit_price")
  totalPrice  Decimal  @db.Decimal(10, 2) @map("total_price")
  isSelected  Boolean  @default(true) @map("is_selected")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("cart_items")
}

// Customer Health Metrics
model CustomerHealthMetrics {
  id                    String   @id @default(cuid())
  customerId            String   @unique @map("customer_id")
  customer              Customer @relation(fields: [customerId], references: [id])
  gender                String?
  dateOfBirth           DateTime? @map("date_of_birth")
  bloodPressureSystolic Int?     @map("blood_pressure_systolic")
  bloodPressureDiastolic Int?    @map("blood_pressure_diastolic")
  weight                Float?
  height                Float?
  bmi                   Float?
  bmr                   Float?
  bloodType             String?  @map("blood_type")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  @@map("customer_health_metrics")
}

// Customer Health Records
model CustomerHealthRecord {
  id          String   @id @default(cuid())
  customerId  String   @map("customer_id")
  customer    Customer @relation(fields: [customerId], references: [id])
  recordType  String   @map("record_type")
  title       String
  description String?
  dateRecorded DateTime @map("date_recorded")
  providerName String? @map("provider_name")
  fileUrl     String?  @map("file_url")
  imagePublicId String? @map("image_public_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([customerId])
  @@map("customer_health_records")
}

// Customer Allergies
model CustomerAllergy {
  id          String   @id @default(cuid())
  customerId  String   @map("customer_id")
  customer    Customer @relation(fields: [customerId], references: [id])
  name        String
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("customer_allergies")
}

// Medicine Reminders
model MedicineReminder {
  id           String   @id @default(cuid())
  customerId   String   @map("customer_id")
  customer     Customer @relation(fields: [customerId], references: [id])
  
  medicineName String   @map("medicine_name")
  dosage       String   // "1 pill", "2 tablets"
  
  frequencyType String  @map("frequency_type") // "DAILY", "WEEKDAYS", "WEEKENDS", "SPECIFIC_DAYS", "INTERVAL", "ONE_TIME"
  specificDays  Json?   @map("specific_days") // [1,3,5] for Mon,Wed,Fri
  intervalDays  Int?    @map("interval_days") // For "INTERVAL" type
  time          String   // "08:00" format
  startDate     DateTime @map("start_date")
  endDate       DateTime? @map("end_date")
  
  isActive      Boolean  @default(true) @map("is_active")
  notes         String?
  
  notifications ReminderNotification[]
  logs          ReminderLog[]
  
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@index([customerId, isActive])
  @@index([time])
  @@map("medicine_reminders")
}

// Reminder Notifications
model ReminderNotification {
  id              String   @id @default(cuid())
  reminderId      String   @map("reminder_id")
  reminder        MedicineReminder @relation(fields: [reminderId], references: [id])
  scheduledTime   DateTime @map("scheduled_time")
  status          NotificationStatus @default(PENDING)
  pushNotificationId String? @map("push_notification_id")
  sentAt          DateTime? @map("sent_at")
  acknowledgedAt  DateTime? @map("acknowledged_at")
  errorMessage    String?  @map("error_message")
  createdAt       DateTime @default(now()) @map("created_at")

  logs            ReminderLog[]

  @@index([status, scheduledTime]) // For queue processing
  @@map("reminder_notifications")
}

enum NotificationStatus {
  PENDING
  SENT
  DELIVERED
  ACKNOWLEDGED
  FAILED
}

// Reminder Logs
model ReminderLog {
  id                    String   @id @default(cuid())
  reminderId            String   @map("reminder_id")
  reminder              MedicineReminder @relation(fields: [reminderId], references: [id])
  notificationId        String?  @map("notification_id")
  notification          ReminderNotification? @relation(fields: [notificationId], references: [id])
  customerId            String   @map("customer_id")
  customer              Customer @relation(fields: [customerId], references: [id])
  medicineName          String   @map("medicine_name")
  dosage                String
  actionType            String   @map("action_type") // "taken", "skipped", "missed"
  scheduledTime         DateTime @map("scheduled_time")
  actionTime            DateTime? @map("action_time")
  notes                 String?
  createdAt             DateTime @default(now()) @map("created_at")

  @@index([customerId, scheduledTime])
  @@map("reminder_logs")
}

// Customer Notifications (In-app + Push)
model CustomerNotification {
  id          String   @id @default(cuid())
  customerId  String   @map("customer_id")
  customer    Customer @relation(fields: [customerId], references: [id])
  type        CustomerNotificationType
  title       String
  message     String
  metadata    Json?    // Additional data (e.g., orderId, orderNumber)
  isRead      Boolean  @default(false) @map("is_read")
  pushSent    Boolean  @default(false) @map("push_sent") // Track if push notification was sent
  pushSentAt  DateTime? @map("push_sent_at")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([customerId, isRead])
  @@index([createdAt])
  @@map("customer_notifications")
}

enum CustomerNotificationType {
  ORDER_STATUS_CHANGED  // Order status updates (PENDING -> CONFIRMED, etc.)
  DELIVERY_UPDATE       // Delivery status updates
  MEDICINE_REMINDER     // Medicine reminder (also creates ReminderNotification for push)
}

// Customer Push Tokens (For mobile push notifications)
model CustomerPushToken {
  id          String   @id @default(cuid())
  customerId  String   @map("customer_id")
  customer    Customer @relation(fields: [customerId], references: [id])
  token       String   @unique // Expo push token
  deviceType  String   @map("device_type") // "ios", "android"
  deviceId    String?  @map("device_id")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([customerId, isActive])
  @@map("customer_push_tokens")
}

